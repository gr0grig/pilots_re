# Система рендеринга

## Общее описание

Система рендеринга движка Pilots — это палитровая 2D-система, работающая в 256-цветном режиме. Она построена на трёхуровневой архитектуре: управление объектами отрисовки (render.c), графическая инициализация и вывод на экран (graphics.c), низкоуровневые операции копирования пикселей (blitting.c).

Главная оптимизация рендеринга — система «грязных регионов», благодаря которой на каждом кадре перерисовываются только те области экрана, в которых произошли изменения.

## Объекты отрисовки

Основная единица рендеринга — структура RenderObject. Каждый видимый элемент на экране (спрайт, текстовый символ, курсор) представлен одним или несколькими объектами отрисовки.

Каждый объект отрисовки содержит следующую информацию:

**Флаги состояния** определяют, выделен ли объект, видим ли он, нужно ли его отразить и другие параметры поведения. Флаг с битом 0x01 означает, что слот занят; бит 0x80 означает видимость объекта; бит 0x40 управляет горизонтальным отражением.

**Индекс слота** связывает объект отрисовки с конкретным слотом спрайта или шрифта, откуда берутся графические данные.

**Информация о рендеринге** содержит режим наложения, атрибуты прозрачности и прочие параметры отображения.

**Связь с анимацией** — индекс слота анимации, управляющего сменой кадров.

**Индекс родителя** позволяет строить иерархии объектов. Объект может быть привязан к родительскому, и тогда его позиция вычисляется относительно родителя. Значение 0xFFFF означает отсутствие родителя.

**Координаты** — позиция объекта на экране в пикселях.

**Указатель на данные спрайта** — адрес в памяти, где хранятся пиксельные данные текущего кадра.

## Пул объектов отрисовки

Объекты отрисовки размещаются в специальном пуле фиксированного размера. Пул работает по принципу нисходящего выделения: новые объекты выделяются от верхней границы пула вниз. Каждый объект занимает 16 байт.

При выделении нового объекта функция AllocRenderObject ищет свободный слот, начиная от текущей верхней границы и двигаясь вниз. Свободность определяется по флагу в первом байте — если бит 0x01 не установлен, слот свободен.

Освобождение объекта выполняется функцией FreeRenderObject, которая сбрасывает флаг выделения и при необходимости обновляет границы пула.

Максимальная вместимость пула — до 256 объектов одновременно, что вполне достаточно для типичной сцены 2D-игры.

## Слоты спрайтов

Графические данные для объектов отрисовки хранятся в слотах спрайтов. Каждый слот содержит:

**Базовые данные спрайта** — исходный набор пиксельных данных, загруженный из файла ресурсов.

**Текущий указатель данных** — указывает на активный кадр или вариант спрайта. Может отличаться от базовых данных, если применена анимация или трансформация.

**Массив подобъектов** — некоторые спрайты состоят из нескольких частей (например, составные персонажи). Массив подобъектов хранит указатели на данные каждой части.

**Указатель скрипта** — спрайты могут иметь собственные скрипты анимации, управляющие сменой кадров и трансформациями.

Движок поддерживает до 256 слотов спрайтов одновременно.

## Грязные регионы

Система грязных регионов — ключевая оптимизация рендеринга. Вместо полной перерисовки экрана на каждом кадре, движок отслеживает, какие области изменились, и перерисовывает только их.

Когда объект отрисовки перемещается, меняет кадр анимации, появляется или исчезает, область экрана, которую он занимает, помечается как «грязная». Дополнительно помечается и та область, где объект находился до изменения (чтобы стереть его старое изображение).

На этапе рендеринга движок обходит все грязные регионы. Для каждого региона выполняется следующая последовательность:

Сначала область очищается — заполняется фоном (тайлы фоновой карты или сплошной цвет).

Затем определяются все объекты отрисовки, пересекающиеся с данным регионом. Объекты отрисовываются в порядке слоёв — от нижнего к верхнему. Движок поддерживает 16 слоёв отрисовки, что позволяет управлять порядком наложения элементов.

После отрисовки всех объектов в регион, содержимое этой области копируется из заднего буфера на экран.

## Задний буфер

Рендеринг выполняется в задний буфер (backbuffer) — область памяти, представляющую собой полное изображение экрана. Задний буфер выделяется при инициализации графической подсистемы и имеет размер, соответствующий разрешению игры.

Каждый пиксель в заднем буфере — это один байт, представляющий индекс цвета в текущей палитре. Такое представление минимизирует потребление памяти и ускоряет операции копирования.

Инициализация заднего буфера включает вычисление «шага строки» (stride) — количества байт между началами соседних строк. Это значение учитывает возможное выравнивание строк и используется во всех операциях блиттинга для правильной адресации пикселей.

## Операции блиттинга

Блиттинг (от «blit» — block image transfer) — это копирование прямоугольного блока пикселей из одного места в другое. Движок реализует несколько типов блиттинга:

**Простое копирование** — прямое побайтовое копирование из источника в приёмник. Используется для непрозрачных спрайтов.

**Копирование с прозрачностью** — при копировании пиксели с определённым значением (обычно 0) пропускаются, что создаёт эффект прозрачного фона.

**Аддитивное наложение** — значения пикселей источника прибавляются к значениям приёмника. Это создаёт эффект свечения и полупрозрачности.

**RLE-декомпрессия с отрисовкой** — некоторые спрайты хранятся в сжатом формате RLE (Run-Length Encoding). Движок декодирует их «на лету» при отрисовке, что экономит память.

Движок использует таблицу указателей на функции блиттинга, что позволяет динамически выбирать подходящий метод для каждого объекта в зависимости от его атрибутов рендеринга.

## Трансформации

При отрисовке объекта к нему могут быть применены геометрические трансформации:

**Горизонтальное отражение** — спрайт отрисовывается зеркально по горизонтали. Используется, например, для персонажа, смотрящего влево, когда имеется только спрайт для правого направления.

**Вертикальное отражение** — зеркальное отражение по вертикали.

**Поворот на 90 градусов** — спрайт поворачивается на 90 градусов по или против часовой стрелки.

**Поворот на 180 градусов** — комбинация горизонтального и вертикального отражения.

**Диагональное отражение** — отражение относительно диагонали, что эквивалентно транспозиции матрицы пикселей.

Трансформации реализуются через изменение порядка обхода пикселей при блиттинге. Сами данные спрайта не модифицируются — меняется только способ их чтения.

## Палитра

Движок работает в палитровом режиме с 256 цветами. Палитра представляет собой массив из 256 записей, каждая из которых содержит три компоненты цвета (красный, зелёный, синий).

Палитра загружается из файла ресурсов и может быть изменена в ходе игры — например, при переходе между сценами или при воспроизведении видео. Каждая сцена может иметь собственную палитру.

Для вывода палитрового изображения на экран через GDI движок создаёт логическую палитру Windows и ассоциирует её с контекстом устройства окна.

## Вывод на экран

Финальный этап — копирование содержимого заднего буфера (или его частей) в окно приложения. Движок поддерживает два метода вывода:

**BitBlt** — стандартная операция GDI для копирования прямоугольных областей. Используется, когда размер окна совпадает с размером заднего буфера.

**StretchDIBits** — позволяет масштабировать изображение при копировании. Используется, когда размер окна отличается от внутреннего разрешения игры, и обеспечивает растягивание картинки до размеров окна.

## Эффект растворения

Движок поддерживает эффект плавного растворения (dissolve) при переходах между сценами. Этот эффект реализован через 16-проходный дизеринг: на каждом проходе обновляется определённый набор пикселей, формируя визуальный эффект постепенного проявления или исчезновения изображения.

Паттерн дизеринга хранится в заранее вычисленной таблице, которая определяет, какие пиксели обновляются на каждом из 16 проходов.

## Послойная отрисовка

Все объекты отрисовки распределяются по 16 слоям. Слой определяется атрибутами объекта и задаётся при его создании или через скриптовые команды.

При рендеринге грязного региона объекты отрисовываются строго в порядке слоёв: сначала нижний слой (фон), затем промежуточные, и в последнюю очередь — верхний слой (интерфейс, курсор). Это гарантирует правильное перекрытие элементов.

Курсор мыши всегда отрисовывается поверх всех остальных объектов, так как является специальным объектом отрисовки без родителя и с наивысшим приоритетом слоя.
