# Управление ресурсами

## Общее описание

Система управления ресурсами отвечает за загрузку всех игровых данных из файла ресурсов: спрайтов, звуков, шрифтов, анимаций, скриптов и видеороликов. Основная реализация находится в файле resource.c, а диспетчер инициализации ресурсов — в gameloop.c.

## Файл данных

Все игровые ресурсы упакованы в единый файл данных. В начале файла расположена таблица смещений, по которой движок находит конкретные ресурсы по их идентификаторам. Каждая запись в таблице содержит смещение ресурса в файле и его размер.

При запуске движок открывает файл данных и считывает таблицу смещений в память. В дальнейшем загрузка любого ресурса сводится к переходу по смещению и чтению данных нужного размера.

Файл данных не перезагружается целиком — ресурсы загружаются по требованию, когда они впервые нужны. Это экономит оперативную память, позволяя работать с файлами данных, превышающими объём доступной памяти.

## Буферизованное чтение

Для эффективной работы с файлом данных используется система буферизованного чтения. Вместо множества мелких обращений к диску данные считываются блоками и кэшируются в промежуточном буфере.

Запрос на чтение проверяет, есть ли нужные данные в буфере. Если есть — они возвращаются напрямую из памяти. Если нет — загружается новый блок с диска. Такой подход значительно сокращает количество дисковых операций, что было критично для производительности на жёстких дисках 1990-х годов.

## Декодирование переменной длины (VLQ)

Размеры ресурсов и некоторые параметры закодированы в формате VLQ (Variable-Length Quantity). В этой кодировке каждый байт содержит 7 бит данных и 1 бит-продолжение. Если бит продолжения установлен, следующий байт также является частью числа.

Этот формат позволяет компактно хранить как малые числа (1 байт для значений до 127), так и большие (несколько байт для значений в тысячи и более). Экономия пространства особенно заметна при хранении таблиц с множеством записей.

## Декомпрессия

Многие ресурсы хранятся в сжатом виде для экономии дискового пространства. При загрузке они декомпрессируются «на лету».

Основной алгоритм сжатия — LZSS (Lempel-Ziv-Storer-Szymanski). Это словарный метод, при котором повторяющиеся последовательности заменяются ссылками на их предыдущие вхождения. Декомпрессор поддерживает скользящее окно и восстанавливает данные, заменяя ссылки обратно на исходные последовательности.

Для некоторых типов ресурсов (например, видеокадров) декомпрессия выполняется покадрово, а не целиком. Буфер декомпрессии выделяется перед началом операции и освобождается после её завершения.

## Типы ресурсов и опкоды

Инициализация ресурсов управляется через систему опкодов, обрабатываемых в функции GameMainLoop. Каждый тип ресурса имеет свой диапазон опкодов.

### Спрайты (опкоды 0x20–0x23)

Спрайтовые ресурсы загружаются в слоты спрайтов. Опкод 0x20 инициализирует слот — задаёт базовые параметры, такие как размеры и формат данных. Опкоды 0x21–0x23 загружают данные различных подкомпонентов: основные пиксельные данные, массив подобъектов (для составных спрайтов) и скрипт анимации спрайта.

### Анимации (опкоды 0x38–0x3A)

Анимационные данные описывают, как чередуются кадры спрайта. Опкод 0x38 загружает битовую маску доступных кадров — она определяет, какие из возможных кадров реально существуют. Опкод 0x39 загружает таблицу выбора кадров — она задаёт последовательность воспроизведения. Опкод 0x3A загружает данные модификации кадров — информацию о трансформациях, применяемых к каждому кадру.

### Шрифты (опкоды 0x40–0x43)

Шрифтовые ресурсы содержат растровые изображения символов. Опкод 0x40 инициализирует слот шрифта — задаёт тип шрифта и базовые параметры. Опкоды 0x41–0x43 загружают данные глифов. Шрифты поддерживают отложенную загрузку: при инициализации запоминается файловое смещение данных глифов, а сами данные загружаются только при первом обращении к конкретному символу.

### Звуки (опкоды 0x50–0x52)

Опкод 0x50 инициализирует слот звукового эффекта. Опкод 0x51 загружает PCM-данные в слот. Опкод 0x52 загружает данные музыкального трека.

### Оверлеи (опкоды 0x60–0x61)

Опкод 0x60 загружает спрайтовые данные оверлея — графических элементов, которые отрисовываются поверх основной сцены. Опкод 0x61 загружает координатные данные оверлея — информацию о его позиционировании.

## Загрузка по идентификатору

Функция LoadResourceById принимает числовой идентификатор ресурса и выполняет его загрузку. Процесс состоит из нескольких шагов:

По идентификатору вычисляется смещение в таблице ресурсов. Из таблицы считываются файловое смещение и размер данных. Указатель чтения перемещается на нужную позицию в файле. Данные считываются через буферизованное чтение и при необходимости декомпрессируются.

Результатом является указатель на загруженные данные в памяти, готовые к использованию соответствующей подсистемой.

## Отложенная загрузка

Для некоторых типов ресурсов используется стратегия отложенной загрузки. Вместо немедленного считывания всех данных при инициализации, запоминается только файловое смещение. Данные загружаются позже, при первом фактическом обращении.

Эта стратегия применяется для шрифтов (глифы загружаются при первой отрисовке символа) и для некоторых крупных спрайтовых ресурсов. Отложенная загрузка уменьшает время инициализации сцены и снижает пиковое потребление памяти.

Информация для отложенной загрузки хранится в структуре DeferredLoadInfo, содержащей файловое смещение и размер данных.

## Жизненный цикл ресурсов

Ресурсы загружаются при инициализации сцены (когда обрабатываются опкоды ресурсов) и остаются в памяти до завершения сцены или до явного освобождения. При переходе между сценами ресурсы предыдущей сцены освобождаются, а ресурсы новой — загружаются.

Память для ресурсов выделяется из общего пула памяти (подробнее в разделе «Управление памятью»). Когда ресурс больше не нужен, его память возвращается в пул и может быть использована для других целей.
