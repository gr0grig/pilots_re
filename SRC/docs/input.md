# Обработка ввода

## Общее описание

Система ввода движка Pilots обрабатывает события клавиатуры и мыши, поступающие через стандартный механизм оконных сообщений Windows. Входные данные преобразуются во внутренний формат и передаются скриптовой системе через глобальные переменные. Основная обработка реализована в оконной процедуре MainWndProc (файл main.c), с вспомогательными функциями в input.c.

## Конфигурация ввода

Параметры ввода хранятся в структуре InputConfig, которая определяет:

**Флаги режимов** — битовое поле, управляющее доступными режимами ввода. Бит 0 включает обработку клавиатуры, бит 1 включает обработку мыши. Скрипты могут динамически включать и отключать эти режимы — например, заблокировать клавиатуру во время катсцены, оставив активной только мышь.

**Восемь игровых клавиш** — каждая из восьми позиций хранит виртуальный код клавиши Windows (VK-код). Это основные клавиши управления, которые скрипты используют для обработки действий игрока. Назначение клавиш задаётся при инициализации и может быть изменено.

**Четыре специальные клавиши** — дополнительные клавиши для особых функций, специфичных для конкретной игры.

## Обработка клавиатуры

### Сообщение WM_KEYDOWN

При нажатии клавиши оконная процедура получает сообщение WM_KEYDOWN. Обработчик выполняет следующую последовательность:

Сначала виртуальный код нажатой клавиши сравнивается с каждой из восьми настроенных игровых клавиш. Если совпадение найдено, индекс клавиши (от 0 до 7) записывается в поле keyIndex структуры VideoConfig.

Если при нажатии удерживается клавиша Shift, к индексу прибавляется 8, что позволяет скриптам различать обычное нажатие и нажатие с модификатором.

Одновременно с записью индекса клавиши фиксируются текущие координаты курсора мыши. Это позволяет скриптам узнать, где находился курсор в момент нажатия клавиши, что полезно для комбинированных взаимодействий «клавиша + позиция».

Если нажатая клавиша не совпадает ни с одной из игровых, проверяются четыре специальные клавиши. Обработка специальных клавиш выполняется аналогично, но с отдельными индексами.

### Сообщение WM_CHAR

Сообщение WM_CHAR содержит символьный код нажатой клавиши (с учётом раскладки и модификаторов). Этот код записывается в поле charCode структуры VideoConfig и используется скриптами для текстового ввода — например, при вводе имени в поле сохранения.

## Обработка мыши

### Перемещение курсора

Сообщение WM_MOUSEMOVE обновляет координаты курсора в полях cursorX и cursorY структуры VideoConfig. Координаты берутся из параметра сообщения и представляют позицию курсора в клиентской области окна.

При обновлении координат также обновляется специальный объект отрисовки курсора (g_CursorObject), что позволяет системе рендеринга корректно перерисовать курсор в новой позиции.

### Нажатие левой кнопки мыши

Сообщение WM_LBUTTONDOWN генерирует внутренний код события -127. Этот код записывается в поле ввода и позволяет скриптам реагировать на клики. Одновременно фиксируются координаты клика.

### Отпускание левой кнопки мыши

Сообщение WM_LBUTTONUP генерирует код события -126. Это позволяет скриптам отличать нажатие от отпускания, что используется для обработки перетаскивания и других взаимодействий.

### Правая кнопка мыши

Сообщения WM_RBUTTONDOWN и WM_RBUTTONUP обрабатываются аналогично левой кнопке, но с другими внутренними кодами событий.

### Управление курсором

Сообщение WM_SETCURSOR обрабатывается для управления внешним видом системного курсора. В зависимости от текущего режима игры курсор может отображаться как стандартная стрелка или быть полностью скрытым (если игра использует собственный спрайтовый курсор).

## Режимы ввода

Скриптовая система использует два основных режима ввода, проверяемых через нативные функции:

**Режим клавиатурного ввода** — активен, когда движок ожидает нажатия определённой клавиши. В этом режиме каждое нажатие сопоставляется с игровыми клавишами, и результат передаётся скрипту.

**Режим ожидания клика** — активен, когда движок ожидает клика мышью. В этом режиме движок фиксирует позицию клика и передаёт её скрипту для обработки.

Нативные функции позволяют скриптам проверять, какой режим ввода в данный момент активен, и читать результат ввода (индекс нажатой клавиши или координаты клика).

## Очистка буфера ввода

Функция в файле input.c выполняет очистку накопленных событий ввода. Она сбрасывает индекс нажатой клавиши, код символа и флаги кликов. Эта функция вызывается в начале ожидания нового ввода, чтобы предотвратить обработку устаревших событий.

Дополнительно при очистке буфера проверяется состояние музыкального сопровождения — если музыка была прервана, она возобновляется.

## Передача ввода скриптам

Ввод от пользователя попадает в скриптовую систему через глобальные переменные, доступные из виртуальной машины. Скрипты периодически проверяют эти переменные и реагируют на изменения.

Типичный сценарий: скрипт устанавливает режим ожидания ввода и выполняет инструкцию yield, возвращая управление игровому циклу. На следующих кадрах игровой цикл обрабатывает события ввода и записывает их в глобальные переменные. Когда скрипт возобновляет выполнение, он проверяет переменные и обнаруживает произошедший ввод.

Такая модель «опроса» (polling) типична для игровых движков того периода и хорошо сочетается с кооперативной многозадачностью скриптовой системы.
