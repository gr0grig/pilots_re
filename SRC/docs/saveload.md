# Система сохранений

## Общее описание

Система сохранений движка Pilots позволяет сериализовать текущее состояние игры в файл и восстановить его при загрузке. Реализация находится в файле saveload.c, вспомогательные функции работы с файлами — в fileio.c.

## Формат файла сохранения

Файл сохранения имеет бинарный формат и начинается с магического числа, позволяющего движку идентифицировать файл как корректное сохранение. Магическое число определено в globals.c и проверяется при каждой загрузке.

После магического числа следует зашифрованный блок данных, содержащий полное состояние игры. Шифрование выполняется для предотвращения простого редактирования файлов сохранения.

## XOR-шифрование

Данные сохранения шифруются простым алгоритмом XOR с 32-байтовым ключом. Каждый байт данных подвергается операции исключающего ИЛИ с соответствующим байтом ключа (по модулю длины ключа).

Этот метод шифрования симметричен — одна и та же операция используется как для шифрования, так и для дешифрования. При сохранении данные шифруются перед записью; при загрузке — дешифруются после чтения.

Хотя XOR-шифрование не обеспечивает криптографической стойкости, для целей защиты файлов сохранения от случайного редактирования оно вполне достаточно.

## Сериализуемые данные

При сохранении записывается полное состояние игры, включающее:

**Глобальные переменные игры** — весь блок game_globals_struct, содержащий более четырёх тысяч байт данных. Это включает все флаги, счётчики, позиции, идентификаторы текущих ресурсов и прочие переменные, к которым обращаются скрипты.

**Состояние сцены** — указатель на текущую сцену в файле ресурсов, индекс активного снимка и другие параметры, необходимые для восстановления текущего места в игре.

**Пользовательские регионы** — скрипты могут определять произвольные области данных, которые должны быть включены в сохранение. Это позволяет сохранять специфичные для конкретной игры данные, формат которых известен только скриптам.

## Процесс сохранения

При инициации сохранения (по команде скрипта или через действие игрока) выполняется следующая последовательность:

Формируется путь к файлу сохранения. Основной путь — директория исполняемого файла. Если запись туда невозможна, используется альтернативный путь — временная директория.

Файл открывается для записи в бинарном режиме. Записывается магическое число. Далее собираются все данные для сохранения: глобальные переменные, параметры сцены, пользовательские регионы.

Собранные данные шифруются XOR-ключом и записываются в файл. Файл закрывается.

## Процесс загрузки

При загрузке выполняется обратная последовательность:

Файл открывается для чтения. Считывается и проверяется магическое число — если оно не совпадает, файл считается повреждённым, и загрузка прерывается.

Зашифрованные данные считываются и дешифруются. Восстанавливаются глобальные переменные, параметры сцены и пользовательские регионы.

После восстановления данных движок воссоздаёт визуальное состояние: загружает ресурсы текущей сцены, восстанавливает снимок экрана, инициализирует объекты отрисовки. Игра продолжается с точки сохранения.

## Проверка целостности

Помимо магического числа, система сохранений может выполнять дополнительную проверку целостности данных. Это позволяет обнаружить повреждение файла из-за сбоя записи, ошибки диска или некорректного редактирования.

Если проверка целостности не проходит, загрузка прерывается и игроку сообщается об ошибке.

## Пользовательские регионы сохранения

Скрипты могут регистрировать произвольные области памяти для включения в файл сохранения. Каждый регион определяется адресом начала, размером и идентификатором.

При сохранении все зарегистрированные регионы последовательно записываются в файл с их идентификаторами и размерами. При загрузке регионы восстанавливаются в те же области памяти.

Эта функциональность позволяет каждой конкретной игре сохранять свои уникальные данные, не требуя изменений в самом движке.

## Работа с файловой системой

Файловый ввод-вывод реализован через низкоуровневые функции C (_open, _read, _write, _lseek, _close) в бинарном режиме. Это обеспечивает побайтовую точность при записи и чтении структур данных.

При формировании пути к файлу сохранения движок сначала пробует использовать директорию рядом с исполняемым файлом. Если запись невозможна (например, из-за отсутствия прав на запись), используется альтернативный путь — как правило, временная директория Windows.

Имя файла сохранения формируется из базового имени и индекса слота, что позволяет поддерживать несколько слотов сохранения.

## Ограничения

Система сохранений сериализует состояние целиком — нет возможности сохранить только часть состояния или выполнить инкрементное сохранение. Каждое сохранение полностью перезаписывает файл.

Размер файла сохранения фиксирован и определяется размером сериализуемых данных. Для типичной игры это несколько килобайт, что пренебрежимо мало по современным стандартам.
