# Тайловая карта и поиск пути

## Общее описание

Тайловая карта — это основа пространственной организации игрового мира в движке Pilots. Мир разделён на прямоугольную сетку тайлов (клеток), каждый из которых имеет определённый тип и свойства проходимости. На базе тайловой карты работает система перемещения персонажей и алгоритм поиска пути. Реализация сосредоточена в файле tilemap.c.

## Структура тайловой карты

Тайловая карта хранится в буфере g_TileMapBuffer и представляет собой двумерный массив. Размеры карты определяются глобальными переменными g_ScreenWidth и g_ScreenHeight (в тайлах).

Каждый тайл занимает два байта и содержит индекс тайла (определяющий его визуальный вид и тип) и маску слоя (определяющую, к какому слою относится тайл). Тип тайла определяет его поведение — является ли он проходимым, является ли препятствием, обладает ли особыми свойствами.

## Карта проходимости

Для работы системы перемещения и поиска пути создаётся карта проходимости (walk map) — двумерный массив, где каждая клетка отмечена как проходимая или непроходимая.

Движок предоставляет несколько способов построения карты проходимости, каждый из которых подходит для разных ситуаций.

### Полностью проходимая карта

Функция BuildWalkMapAllPassable создаёт карту, в которой все клетки отмечены как проходимые. Используется для сцен без препятствий или когда проходимость контролируется иным способом.

### Карта по типу тайлов

Функция BuildWalkMapByTileType анализирует тип каждого тайла и определяет его проходимость на основании предопределённых правил. Определённые типы тайлов считаются проходимыми (земля, дорога), другие — непроходимыми (стены, вода).

### Карта с произвольными препятствиями

Функция BuildWalkMapWithObstacles использует битовую маску для определения, какие типы тайлов являются препятствиями. Это даёт скриптам гибкий контроль — например, можно сделать воду проходимой для лодки, но непроходимой для пешехода.

### Прямая карта по типу

Функция BuildWalkMapDirectByType выполняет прямое сопоставление типов тайлов с проходимостью, без промежуточных вычислений. Этот метод используется для простых случаев, когда маппинг однозначен.

## Система позиций

Текущая позиция активного объекта на тайловой карте хранится в глобальных переменных g_CurrentTileX_Wrapped и g_CurrentTileY_Wrapped. Предыдущая позиция сохраняется в g_PreviousTileX и g_PreviousTileY. Текущее направление движения хранится в g_CurrentDirection.

«Wrapped» в названии указывает на то, что координаты могут «заворачиваться» — при выходе за границу карты позиция переносится на противоположную сторону. Это позволяет создавать зацикленные карты.

## Поиск пути

### Настройка целей

Перед началом поиска пути функция SetupPathfindPositions устанавливает начальную и целевую позиции. Эти позиции используются алгоритмом для вычисления направления движения.

### Вычисление направления

Функция ComputeDirectDirection вычисляет оптимальное направление движения от текущей позиции к цели. Алгоритм работает следующим образом:

Сначала вычисляются расстояния по осям X и Y между текущей позицией и целью. На основе соотношения этих расстояний определяются основное и второстепенное направления.

Если расстояние по X значительно больше расстояния по Y, основным направлением будет горизонтальное (влево или вправо). Если больше расстояние по Y — вертикальное (вверх или вниз). Если расстояния примерно равны — диагональное.

Результатом является число от 0 до 7, кодирующее одно из восьми возможных направлений. Это значение используется скриптами для перемещения персонажа и выбора соответствующего кадра анимации.

### Обход препятствий

При наличии препятствий на прямом пути алгоритм может корректировать направление. Если основное направление заблокировано, проверяется второстепенное. Если и оно недоступно, выполняется поиск ближайшего обходного пути.

Алгоритм поиска пути в этом движке не является полноценным A* или подобным — это упрощённая жадная эвристика, достаточная для простых 2D-игр с небольшими картами. Она быстра в вычислении и в большинстве случаев находит приемлемый путь.

## Поиск тайлов

Движок предоставляет функции для поиска тайлов с определёнными свойствами на карте. Это используется, например, для нахождения ближайшего интерактивного объекта, определения типа поверхности под персонажем или поиска целевой клетки для перемещения.

Функция поиска по паттерну перебирает тайлы карты и сравнивает их тип с искомым. При нахождении совпадения возвращаются координаты тайла. Поиск может быть ограничен определённой областью карты для повышения производительности.

## Система направлений

Направления в движке кодируются числами от 0 до 7 для восьминаправленного перемещения:

- 0 — вверх (север)
- 1 — вверх-вправо (северо-восток)
- 2 — вправо (восток)
- 3 — вниз-вправо (юго-восток)
- 4 — вниз (юг)
- 5 — вниз-влево (юго-запад)
- 6 — влево (запад)
- 7 — вверх-влево (северо-запад)

Эта нумерация используется повсеместно в движке: при вычислении путей, выборе кадров анимации, ремаппинге направлений при трансформациях и обработке ввода.

## Вычисление расстояний

Для определения расстояний между позициями на карте используется манхэттенское расстояние — сумма абсолютных разностей координат по обеим осям. Этот метод прост в вычислении и адекватно отражает расстояние на тайловой сетке, где перемещение возможно только по сторонам и диагоналям клеток.

Соотношение расстояний по осям используется для выбора между основными (горизонтальным, вертикальным) и диагональными направлениями движения.

## Взаимодействие со скриптами

Скриптовая система управляет тайловой картой и перемещением через глобальные переменные и нативные функции. Скрипты могут:

- Запрашивать тип тайла в заданной позиции
- Устанавливать целевую позицию для поиска пути
- Получать вычисленное направление к цели
- Изменять карту проходимости (делать ранее непроходимые тайлы проходимыми и наоборот)
- Перемещать объекты по карте, изменяя их координаты

Перемещение в движке полностью управляется скриптами — нет встроенной «физики» или автоматического движения. Скрипт явно запрашивает направление к цели, проверяет проходимость целевой клетки и обновляет позицию объекта.
