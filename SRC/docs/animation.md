# Система анимаций

## Общее описание

Система анимаций движка Pilots управляет визуальным поведением спрайтов во времени: сменой кадров, применением трансформаций и выбором правильного варианта спрайта в зависимости от направления движения. Основная реализация находится в файле animation.c, с дополнительной логикой обновления в render.c.

## Слоты анимаций

Анимационные данные организованы в слоты. Каждый слот анимации содержит три компонента:

**Битовая маска кадров** определяет, какие кадры анимации доступны для данного спрайта. Не все возможные кадры обязаны существовать — маска позволяет пропускать ненужные. Например, если спрайт имеет только четыре направления из восьми возможных, маска будет содержать единицы только в четырёх позициях.

**Таблица выбора кадров** задаёт последовательность воспроизведения анимации. Вместо простого перебора кадров по порядку, таблица позволяет создавать произвольные последовательности — включая циклы, пингпонг-анимации и нелинейные переходы.

**Данные модификации кадров** содержат информацию о трансформациях, которые нужно применить к каждому кадру. Например, один и тот же кадр спрайта может использоваться для нескольких направлений, если к нему применяются различные отражения и повороты.

Движок поддерживает до 256 слотов анимаций одновременно.

## Трансформации спрайтов

Ключевая оптимизация системы анимаций — генерация нескольких направлений из одного набора кадров путём применения геометрических трансформаций. Это значительно экономит память и дисковое пространство.

### Поворот на 90 градусов против часовой стрелки

Используется для получения направления «вверх» из спрайта, нарисованного для направления «вправо», или аналогичных преобразований. Пиксели спрайта переставляются так, что строки становятся столбцами с обратным порядком.

### Поворот на 180 градусов

Комбинация горизонтального и вертикального отражений. Используется для получения противоположного направления — например, «влево-вниз» из «вправо-вверх».

### Поворот на 90 градусов по часовой стрелке

Обратная операция к повороту против часовой стрелки. Строки становятся столбцами, но в прямом порядке.

### Горизонтальное отражение

Зеркальное отражение спрайта относительно вертикальной оси. Самая частая трансформация — позволяет получить «идущего влево» персонажа из спрайта «идущего вправо».

### Вертикальное отражение

Зеркальное отражение относительно горизонтальной оси. Используется реже, в основном для симметричных объектов.

### Диагональное отражение

Отражение относительно главной диагонали (транспозиция). Используется для генерации диагональных направлений из горизонтальных.

### Антидиагональное отражение

Отражение относительно побочной диагонали. Дополняет диагональное отражение для покрытия всех восьми направлений.

## Направления и их ремаппинг

Движок поддерживает как восьминаправленные, так и шестнадцатинаправленные спрайты. Каждое направление кодируется числом:

Для восьми направлений используются значения от 0 до 7, где 0 — вверх, и далее по часовой стрелке: вверх-вправо, вправо, вниз-вправо, вниз, вниз-влево, влево, вверх-влево.

Система ремаппинга направлений позволяет преобразовывать одно направление в другое с учётом применённой трансформации. Если к спрайту применён горизонтальный поворот, то направление «вправо» ремаппируется в «влево», «вверх-вправо» — в «вверх-влево» и так далее.

Таблицы ремаппинга заранее вычислены для каждого типа трансформации, что обеспечивает быстрое преобразование без вычислений в рантайме.

## Обновление анимаций

На каждом кадре игрового цикла система обходит все активные объекты отрисовки и проверяет, нужно ли обновить их анимацию.

Процесс обновления анимации для одного объекта:

Сначала проверяется, привязан ли объект к слоту анимации. Если нет — объект статичен и обновление не требуется.

Далее проверяется счётчик кадров анимации. Если с момента последнего обновления прошло достаточно времени (определяется скоростью анимации), выполняется переход к следующему кадру.

Следующий кадр определяется по таблице выбора кадров из слота анимации. Из таблицы извлекается индекс нового кадра и информация о необходимых трансформациях.

Указатель данных спрайта в объекте отрисовки обновляется, чтобы указывать на данные нового кадра. Если к кадру нужно применить трансформацию, устанавливаются соответствующие флаги объекта.

Наконец, область экрана, занятая объектом, помечается как «грязная» для перерисовки.

## Случайный выбор кадра

Для некоторых анимаций используется случайный выбор кадра вместо последовательного. Это создаёт эффект непредсказуемости — например, для мерцания огня или искр.

Случайность обеспечивается линейным конгруэнтным генератором с параметрами: множитель 1103515245 и приращение 12345. Генератор инициализируется значением системного времени, что даёт различные последовательности при каждом запуске.

## Связь с системой рендеринга

Система анимаций тесно интегрирована с рендерингом. Каждый объект отрисовки содержит поле animLink — индекс связанного слота анимации. Значение 0xFFFF означает отсутствие анимации (статичный объект).

При обновлении кадра анимации изменяется указатель spriteDataPtr в объекте отрисовки, направляя его на данные нового кадра. Система рендеринга использует этот указатель при отрисовке, автоматически отображая актуальный кадр.

Флаги трансформаций в объекте отрисовки (биты поля flags) указывают системе блиттинга, какую трансформацию применить при отрисовке данных спрайта.
