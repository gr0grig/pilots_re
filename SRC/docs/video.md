# Воспроизведение видео

## Общее описание

Движок Pilots содержит встроенный видеоплеер для воспроизведения игровых роликов — заставок, катсцен, промежуточных видео. Видео хранится в собственном формате с LZSS-сжатием и воспроизводится непосредственно движком, без использования внешних кодеков. Реализация находится в файле video.c.

## Формат видео

Видеоданные представляют собой последовательность сжатых кадров с заголовком. Формат не является стандартным — он специфичен для движка и был разработан для минимальных требований к процессору при декодировании.

### Заголовок видео

Заголовок содержит метаданные ролика: размеры кадра, количество кадров, скорость воспроизведения, информацию о звуковом сопровождении и палитру.

### Чанки данных

Видеоданные организованы в чанки (chunks) — логические блоки, содержащие один или несколько кадров. Функция обработки чанков считывает заголовок чанка, определяет его тип и передаёт данные соответствующему обработчику.

## LZSS-декомпрессия

Каждый кадр видео сжат алгоритмом LZSS (Lempel-Ziv-Storer-Szymanski). Этот алгоритм основан на словарном методе с скользящим окном.

Принцип работы: входной поток содержит смесь литеральных байтов (которые копируются в выходной буфер как есть) и ссылок назад (которые указывают на уже декодированные данные). Ссылка состоит из смещения назад и длины — она означает «скопируй N байт, начиная с позиции, которая была M байт назад».

Управляющие биты определяют, что следует далее — литерал или ссылка. Декодер читает управляющий байт, обрабатывает восемь следующих элементов (по одному биту на каждый), затем переходит к следующему управляющему байту.

LZSS хорошо подходит для видеоданных, так как последовательные кадры часто содержат повторяющиеся паттерны (неизменившиеся области сцены), которые эффективно сжимаются ссылками.

## Буферы кадров

Для декодирования и отображения видео используются несколько буферов:

**Буфер текущего кадра** — область памяти, в которую декодируется текущий кадр. После декодирования содержимое этого буфера копируется на экран (в задний буфер рендеринга).

**Буфер палитры** — видео может содержать собственную палитру, отличную от палитры текущей сцены. При начале воспроизведения палитра из видео устанавливается как активная, а при завершении — восстанавливается палитра сцены.

## Процесс воспроизведения

Воспроизведение видео — это операция, прерывающая нормальный игровой цикл. При запуске видеоролика текущий контекст игры сохраняется, и управление переходит к видеоплееру.

### Инициализация

Считывается заголовок видео. Выделяются буферы для декодирования. Устанавливается палитра из видеоданных. Определяется скорость воспроизведения.

### Покадровое воспроизведение

Для каждого кадра выполняется:

Чтение сжатых данных кадра из файла. Декомпрессия LZSS в буфер кадра. Копирование декодированного кадра в задний буфер рендеринга. Вывод заднего буфера на экран.

Между кадрами выдерживается задержка, определяемая скоростью воспроизведения. Для контроля времени используется функция timeGetTime.

### Звуковое сопровождение

Видеоролики могут содержать звуковое сопровождение. При наличии звуковой дорожки аудиоданные передаются звуковой подсистеме параллельно с отображением видеокадров. Также может запускаться MIDI-музыка, сопровождающая ролик.

### Завершение

По окончании воспроизведения (или при прерывании пользователем) освобождаются буферы декодирования, восстанавливается палитра сцены и контекст игры. Игровой цикл возобновляется с того состояния, в котором был прерван.

## Управление воспроизведением

### Повтор

Видео может быть настроено на повтор — после завершения воспроизведение начинается сначала. Это используется для зацикленных фоновых роликов (например, анимация меню).

### Скорость

Скорость воспроизведения задаётся в заголовке видео и определяет задержку между кадрами. Разные ролики могут иметь разную скорость в зависимости от содержания и художественного замысла.

### Прерывание

Игрок может прервать воспроизведение нажатием клавиши или кликом мыши. При прерывании видео прекращается немедленно, без доигрывания до конца. Это важно для катсцен, которые игрок может захотеть пропустить при повторном прохождении.

## Счётчик видеорекурсии

Движок ведёт счётчик рекурсии видео — он отслеживает глубину вложенности видеовоспроизведения. Хотя в типичном случае видео не вкладываются друг в друга, этот механизм обеспечивает корректное поведение в нестандартных ситуациях.

Нативные функции позволяют скриптам проверять значение этого счётчика, что даёт возможность определить, воспроизводится ли в данный момент видеоролик.

## Интеграция с игровым циклом

Воспроизведение видео — это особый режим работы движка. Во время воспроизведения стандартный игровой цикл приостанавливается: не исполняются скрипты, не обновляются анимации, не обрабатывается игровой ввод (кроме команд пропуска).

После завершения видео все подсистемы возобновляют работу. Восстанавливается состояние экрана из снимка, возобновляется музыкальное сопровождение (если оно было прервано видео), скриптовая система продолжает исполнение с точки, где было запущено видео.
