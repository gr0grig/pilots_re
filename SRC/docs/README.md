# Pilots Game Engine — Документация

## Обзор

Данный проект представляет собой реконструированный игровой движок **Pilots** — 2D-движок для исполнения игровых сценариев и байткода, изначально скомпилированных в Game Maker. Движок был восстановлен из оригинального исполняемого файла PILOTS.EXE (середина 1990-х годов) и представляет собой полностью самодостаточный плеер для Windows.

## Ключевые особенности

Движок реализует все основные подсистемы, необходимые для работы 2D-игры:

- **Палитровая графика** — 256-цветный рендеринг с поддержкой множества режимов наложения
- **Виртуальная машина скриптов** — стековый интерпретатор байткода с более чем 55 опкодами
- **Система грязных регионов** — оптимизация перерисовки, при которой обновляются только изменённые области экрана
- **Тайловая карта** — сетка тайлов с системой проходимости и поиском пути
- **Анимации спрайтов** — многокадровые анимации с поддержкой трансформаций (поворот, отражение)
- **Звук и музыка** — воспроизведение PCM-эффектов через Wave API и MIDI-музыки через MCI
- **Воспроизведение видео** — встроенный видеоплеер с LZSS-декомпрессией
- **Система сохранений** — сериализация состояния игры с XOR-шифрованием
- **Система снимков сцен** — быстрое сохранение и восстановление состояния экрана

## Архитектура

Движок построен на событийной модели Windows (цикл сообщений) и управляется байткод-скриптами. Игровая логика не написана на C напрямую — она исполняется виртуальной машиной, которая обрабатывает предварительно скомпилированные сценарии. Это делает движок универсальным плеером: он может исполнять любые сценарии, созданные в соответствующем формате.

Основной цикл обработки построен по схеме: получение оконных сообщений, обработка ввода, исполнение скриптов, обновление анимаций, перерисовка изменённых областей экрана.

## Структура исходного кода

| Файл | Назначение |
|------|-----------|
| main.c | Точка входа, создание окна, цикл сообщений |
| gameloop.c | Главный игровой цикл, диспетчер опкодов |
| render.c | Конвейер рендеринга, управление объектами отрисовки |
| graphics.c | Инициализация графики, управление палитрой |
| blitting.c | Низкоуровневые операции копирования пикселей |
| script.c | Виртуальная машина скриптов |
| audio.c | Звуковая система (Wave и MIDI) |
| animation.c | Система анимаций и трансформаций |
| resource.c | Загрузка и декомпрессия ресурсов |
| memory.c | Управление пулами памяти |
| video.c | Воспроизведение видеороликов |
| tilemap.c | Тайловая карта, поиск пути, проходимость |
| text.c | Рендеринг текста, шрифты, оверлеи |
| input.c | Обработка пользовательского ввода |
| fileio.c | Файловый ввод-вывод |
| saveload.c | Система сохранения и загрузки |
| native_funcs.c | Библиотека нативных функций для скриптов |
| globals.c | Инициализация глобальных переменных |

## Заголовочные файлы

| Файл | Назначение |
|------|-----------|
| pilots_types.h | Основные структуры данных движка |
| pilots_fwd.h | Предварительные объявления, указатели на функции блиттинга |
| pilots_globals.h | Внешние объявления функций и переменных |
| game_globals_struct.h | Автогенерированная структура глобальных переменных игры |
| game_globals_init.h | Инициализатор структуры глобальных переменных |
| defs.h | Макросы совместимости с декомпилятором IDA |
| debug_log.h | Инфраструктура отладочного логирования |

## Навигация по документации

- [Архитектура и поток выполнения](architecture.md)
- [Система рендеринга](rendering.md)
- [Виртуальная машина скриптов](scripting.md)
- [Аудиосистема](audio.md)
- [Обработка ввода](input.md)
- [Управление ресурсами](resources.md)
- [Управление памятью](memory.md)
- [Система анимаций](animation.md)
- [Тайловая карта и поиск пути](tilemap.md)
- [Система сохранений](saveload.md)
- [Воспроизведение видео](video.md)
- [Текст и интерфейс](ui.md)
