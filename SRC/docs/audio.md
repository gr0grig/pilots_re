# Аудиосистема

## Общее описание

Аудиосистема движка Pilots обеспечивает воспроизведение двух типов звука: звуковые эффекты в формате PCM через Windows Wave API и музыкальное сопровождение в формате MIDI через интерфейс MCI (Media Control Interface). Вся реализация сосредоточена в файле audio.c.

## Звуковые эффекты (Wave Audio)

### Инициализация

При запуске движка инициализируется устройство вывода звука с фиксированными параметрами: частота дискретизации 11025 Гц, разрядность 8 бит, монофонический режим. Эти параметры соответствуют типичному качеству звука в играх середины 1990-х годов и обеспечивают минимальную нагрузку на процессор.

После открытия устройства создаются четыре звуковых буфера по два килобайта каждый. Буферы подготавливаются через waveOutPrepareHeader и ставятся в очередь на воспроизведение. Такая система с несколькими буферами обеспечивает непрерывное воспроизведение: пока один буфер воспроизводится, остальные заполняются новыми данными.

### Механизм обратного вызова

Когда аудиоустройство завершает воспроизведение буфера, оно отправляет сообщение MM_WOM_DONE в оконную процедуру приложения. Обработчик этого сообщения вызывает функцию микширования, которая заполняет освободившийся буфер новыми звуковыми данными и снова ставит его в очередь.

Такой подход через оконные сообщения гарантирует, что обработка звука происходит в основном потоке приложения, избегая проблем синхронизации, характерных для многопоточных решений.

### Слоты звуков

Звуковые данные организованы в слоты. Каждый слот содержит указатель на PCM-данные звукового эффекта и метаданные (длина, текущая позиция воспроизведения). Скрипты обращаются к звукам по индексу слота.

При воспроизведении звукового эффекта движок извлекает данные из соответствующего слота и начинает подмешивать их в выходной поток. Несколько звуков могут воспроизводиться одновременно — функция микширования суммирует сэмплы от всех активных источников.

### Микширование

Функция микширования вызывается каждый раз, когда буфер освобождается. Она проходит по всем активным звуковым каналам и для каждого сэмпла выходного буфера суммирует вклады от всех источников. Результат ограничивается диапазоном 8-битного значения (0–255), чтобы избежать искажений при переполнении.

После заполнения буфера он передаётся устройству через waveOutWrite для воспроизведения.

### Управление громкостью

Громкость звуковых эффектов задаётся через waveOutSetVolume и принимает значения в диапазоне от 0 до 65535. Громкость может быть изменена скриптами в любой момент — например, при входе в меню настроек.

## Музыка (MIDI)

### Воспроизведение

Музыкальное сопровождение реализовано через интерфейс MCI, предоставляющий высокоуровневые команды для работы с мультимедиа. MIDI-файлы не требуют значительных ресурсов процессора, так как синтез звука выполняется аппаратно или системным MIDI-синтезатором.

Воспроизведение музыки управляется через указатель на функцию, что позволяет абстрагировать конкретную реализацию. Скрипты указывают индекс музыкального трека, и движок начинает его воспроизведение.

### Переключение треков

При переключении музыкального трека сначала останавливается текущее воспроизведение, затем обновляется индекс текущего трека и запускается новый. Движок хранит индекс текущего трека в глобальной переменной, что позволяет восстановить музыку после прерываний (например, после воспроизведения видеоролика).

### Управление громкостью MIDI

Громкость MIDI-музыки задаётся в диапазоне от 0 до 127 (стандартный диапазон MIDI). Значение устанавливается через соответствующие MCI-команды.

## Взаимодействие со скриптами

Скриптовая система управляет звуком через опкоды загрузки ресурсов и нативные функции:

Опкоды 0x50–0x51 инициализируют слоты звуковых эффектов — указывают, какие PCM-данные привязаны к какому слоту. Опкод 0x52 загружает данные музыкального трека.

Нативные функции позволяют скриптам запускать воспроизведение конкретного звука, переключать музыкальный трек, изменять громкость и запрашивать текущее состояние аудиосистемы.

## Прерывание и восстановление

При определённых событиях (воспроизведение видео, переход между сценами) текущая музыка может быть приостановлена. После завершения прерывающего события музыка возобновляется. Текущий индекс экрана и музыкального трека сохраняются, что позволяет корректно восстановить воспроизведение.

В файле input.c содержится вспомогательная функция, которая проверяет, была ли музыка прервана, и при необходимости возобновляет её. Эта проверка выполняется при очистке буфера ввода, что гарантирует восстановление музыки при возврате к нормальному игровому процессу.

## Ограничения

Аудиосистема ограничена возможностями своей эпохи: монофонический звук с частотой 11 кГц и 8-битной глубиной обеспечивает скромное качество по современным стандартам, но полностью соответствует оригинальному звучанию игры. MIDI-музыка зависит от системного синтезатора, поэтому её звучание может различаться на разных компьютерах.
